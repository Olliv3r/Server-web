#!/usr/bin/env bash
# setup - Instala e atualiza o server-web
# 

link="https://raw.githubusercontent.com/Olliv3r/Server-web/main/server-web"

installForApt() {
    if [ -z "$1" ] ; then
	echo -e "\e[31;1m[!] Expecifique o pacote\e[0m"
	exit 1
    fi

    while [ ! -f $PREFIX/bin/$1 ] ; do
	printf "\r\e[32mInstalando pacotes...\e[0m"
	sleep 2
	apt update > /dev/null 2>&1
	apt install $1 > /dev/null 2>&1
    done
    printf "\r\e[32mInstalando pacotes...\e[32;1mOK\n\e[0m"
}

installForCurl() {
    if [ -f $PREFIX/bin/server-web ] ; then
	rm $PREFIX/bin/server-web
    fi

    while [ ! -f $PREFIX/bin/server-web ] ; do
	printf "\r\e[32mConfigurando...\e[0m"
	sleep 2
	curl -LO $link > /dev/null 2>&1
	chmod +x server-web
	cp server-web $PREFIX/bin
    done
    printf "\r\e[32mConfigurando...\e[32;1mOK\n\e[0m"
    sleep 2
}

versionVerify() {
    recentVersion=$(curl -sS $link | grep "^# Versão" | tail -1 | cut -d : -f 1 | tr -d \# | tr -d "ãA-z ")

    if [ -f $PREFIX/bin/server-web ] ; then
	currentVersion=$(cat $PREFIX/bin/server-web | grep "^# Versão" | tail -1 | cut -d : -f 1 | tr -d \# | tr -d "ãA-z ")
        if [ $currentVersion == $recentVersion ] ; then
	    echo -e  "\e[33;1m[!] Versão mais recente será instalada, aguarde.\e[0m"
	    installForCurl
	fi
	echo -e  "\e[33;1m[!] Versão mais recente será instalada, aguarde.\e[0m"
	installForCurl

    elif [ ! -f $PREFIX/bin/server-web ] ; then
	installForApt "curl"
	installForCurl

    else
	echo -e "\e[31;1m Erro ao encontrar o programa\e[0m"
	exit 1
    fi

}

setup() {
    versionVerify
}

setup
